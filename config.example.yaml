# Example configuration file for API Cache Proxy
# This file shows all available options with detailed comments
# Copy to config.yaml and customize for your needs

server:
  host: "0.0.0.0"
  port: 8080
  read_timeout: 30s
  write_timeout: 30s
  idle_timeout: 120s

valkey:
  host: "localhost"  # Use "valkey" when running in Docker
  port: 6379
  password: ""
  db: 0
  max_retries: 3
  pool_size: 10
  min_idle_conns: 5

cache:
  default_ttl: 300s  # 5 minutes
  max_ttl: 3600s     # 1 hour
  
  # Configure caching behavior per endpoint
  endpoints:
    # Example: Exact path match - User API with authorization-based caching
    - path: "/api/v1/users"
      methods: ["GET"]
      ttl: 600s  # 10 minutes
      cache_key_headers: ["Authorization"]
      cache_key_query_params: ["page", "limit"]
    
    # Example: Regex pattern - Match all user detail endpoints like /api/v1/users/123
    - path_regex: "^/api/v1/users/[0-9]+$"
      methods: ["GET"]
      ttl: 900s  # 15 minutes
      cache_key_headers: ["Authorization"]
    
    # Example: Product catalog with category-based caching
    - path: "/api/v1/products"
      methods: ["GET"]
      ttl: 1800s  # 30 minutes
      cache_key_query_params: ["category", "sort"]
    
    # Example: Regex pattern - Match all API v1 endpoints
    - path_regex: "^/api/v1/.*"
      methods: ["GET"]
      ttl: 300s  # 5 minutes (fallback for any v1 API)
    
    # Example: Search with shorter TTL
    - path: "/api/v1/search"
      methods: ["GET"]
      ttl: 300s  # 5 minutes
      cache_key_query_params: ["q", "filter"]

rate_limit:
  enabled: true
  requests_per_second: 100
  burst: 200
  
  # Per-endpoint rate limits
  endpoints:
    # Example: Exact path - Stricter limits for search endpoint
    - path: "/api/v1/search"
      requests_per_second: 10
      burst: 20
    
    # Example: Regex pattern - Rate limit all admin endpoints
    - path_regex: "^/api/v1/admin/.*"
      requests_per_second: 5
      burst: 10

retry:
  enabled: true
  max_attempts: 3
  initial_backoff: 100ms
  max_backoff: 2s
  backoff_multiplier: 2.0
  retryable_status_codes: [500, 502, 503, 504]

upstream:
  base_url: "http://localhost:9000"  # Your upstream service URL
  timeout: 30s
  max_idle_conns: 100
  max_conns_per_host: 10

logging:
  level: "info"      # debug, info, warn, error
  format: "json"     # json, text
  output: "stdout"   # stdout, stderr, file
  file_path: "/var/log/api-cache.log"
